<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IC Label Creator — Ben Eater 6502 (Presets + Print Fix)</title>
  <style>
    :root {
      --paper-zoom: 1;
      --paper-bg: repeating-linear-gradient(
        0deg,
        #f8f8f8 0px,
        #f8f8f8 9px,
        #f0f0f0 9px,
        #f0f0f0 10px
      );
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html {
        /* tile the pattern across the entire page, beyond the viewport */
        background: var(--paper-bg);
        background-repeat: repeat;                    /* redundant for repeating-* gradients, but harmless */
        background-attachment: scroll;                /* default; set to 'fixed' if you prefer a stationary pattern */
    }    
    body {
      margin: 0; padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: #111;
      background: transparent;   
      display: flex;
      flex-direction: column;
      height: 100vh;  /* constrain body to viewport height */
      overflow: hidden;  /* prevent body scroll */
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: white; border-bottom: 1px solid #e5e5e5;
    }
    .toolbar {
      display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;
      padding: .75rem 1rem;
    }
    .toolbar label { font-size: .9rem; color: #333; }
    .toolbar input[type="number"]{ width: 6rem; }
    .toolbar .group { display: flex; gap: .5rem; align-items: center; }
    .toolbar .spacer { flex: 1; }
    .paper-wrap {
      display: grid; place-items: start center;
      padding: 1.25rem;
      flex: 1; 
      overflow: auto;  /* make this the scrollable container */
    }
    .paper-shadow {
      position: relative;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.12)) drop-shadow(0 2px 4px rgba(0,0,0,.08));
      transform-origin: top center;
      transform: scale(var(--paper-zoom));
      transition: transform .2s ease;
      padding-bottom: 1.25rem;  /* add space at bottom matching top padding */
    }
    .paper {
      background: white;
      border: 1px solid #ddd;
      position: relative;
      overflow: hidden;
      margin: 0 auto;
    }
    .paper::after {
      /* print margin preview */
      content: ""; position: absolute; pointer-events: none;
      left: var(--margin-left-mm); right: var(--margin-right-mm);
      top: var(--margin-top-mm); bottom: var(--margin-bottom-mm);
      border: 1px dashed rgba(0,0,0,.15);
    }
    svg { display: block; }
    footer {
      padding: 1rem; font-size: .85rem; color: #555;
      flex-shrink: 0;  /* prevent footer from shrinking */
      background: white; border-top: 1px solid #e5e5e5;
    }
    code.kbd {
      padding: .15rem .35rem; border: 1px solid #ddd; border-radius: .35rem;
      background: #fff; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: .9rem;
    }
    /* PRINT FIX: do NOT hide .paper-wrap; only hide header/footer and remove effects */
    @media print {
      @page {
        margin: 0;
      }
      html { background: white !important; }
      body { background: white !important; }
      header, footer { display: none !important; }
      .paper-wrap { display: block !important; padding: 0 !important; background: transparent !important; }
      .paper-shadow { filter: none !important; transform: none !important; }
      .paper { border: none !important; }
      .paper::after { border: none; }
    }
  </style>

  <!-- style block that we update dynamically to set the @page size to A4 or Letter -->
  <style id="pageSizeStyle"></style>

  <script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>

  <!-- Your original project scripts -->
  <script type="text/javascript" src="ic-label-creator.js"></script>
  <script type="text/javascript" src="chips.js"></script>
</head>
<body>
<header>
  <div class="toolbar" role="region" aria-label="Layout controls">
    <div class="group">
      <label for="paperSelect"><strong>Paper</strong></label>
      <select id="paperSelect">
        <option value="A4">A4 — 210 × 297 mm</option>
        <option value="Letter" selected>Letter — 215.9 × 279.4 mm</option>
      </select>
    </div>

    <div class="group">
      <label><strong>Margins (mm)</strong></label>
      <label>Top <input id="marginTop" type="number" min="0" step="0.1" value="10"></label>
      <label>Right <input id="marginRight" type="number" min="0" step="0.1" value="10"></label>
      <label>Bottom <input id="marginBottom" type="number" min="0" step="0.1" value="10"></label>
      <label>Left <input id="marginLeft" type="number" min="0" step="0.1" value="10"></label>
    </div>

    <div class="group">
      <label for="zoomRange"><strong>Zoom</strong></label>
      <input id="zoomRange" type="range" min="0.5" max="2" step="0.05" value="1" />
      <button id="zoomOut" type="button" title="Zoom out">−</button>
      <span id="zoomVal" aria-live="polite">100%</span>
      <button id="zoomIn" type="button" title="Zoom in">+</button>
    </div>

    <div class="spacer"></div>

    <!-- Presets UI -->
    <div class="group">
      <label for="presetSelect"><strong>Presets</strong></label>
      <select id="presetSelect">
        <option value="">(none)</option>
      </select>
      <button id="applyPreset" type="button" title="Apply selected preset">Apply</button>
      <button id="savePreset" type="button" title="Save current as a new preset">Save</button>
      <button id="deletePreset" type="button" title="Delete selected preset">Delete</button>
    </div>

    <div class="group">
      <button id="resetLayout" type="button">Reset Layout</button>
      <button id="printBtn" type="button">Print</button>
    </div>
  </div>
</header>

<main class="paper-wrap">
  <div id="paperShadow" class="paper-shadow">
    <div id="paper" class="paper">
      <svg id="page"></svg>
    </div>
  </div>
</main>

<footer>
  IC-Label Set "Ben Eater 6502 Breadboard Computer" • Enhanced preview, zoom, selectable A4/Letter, saved presets, and print fix.<br/>
  Based on the original layout that renders into <code class="kbd">#page</code> and uses the global <code class="kbd">globals</code> object.
</footer>

<script>
(function(){
  // ---- page presets (in millimeters) ----
  const PagePresets = {
    A4:      { w: 210.0,  h: 297.0, css: "210mm 297mm" },
    Letter:  { w: 215.9,  h: 279.4, css: "215.9mm 279.4mm" }
  };

  // ---- state ----
  window.globals = window.globals || {};
  const state = {
    paper: 'Letter',
    margins: { top: 10, right: 10, bottom: 10, left: 10 },
    zoom: 1
  };

  // ---- localStorage helpers ----
  const LS_KEYS = {
    LAST: 'icLabelCreator:lastState',
    PRESETS: 'icLabelCreator:presets'
  };

  function loadLastState(){
    try {
      const raw = localStorage.getItem(LS_KEYS.LAST);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (data.paper) state.paper = data.paper;
      if (data.margins) state.margins = data.margins;
      if (typeof data.zoom === 'number') state.zoom = data.zoom;
    } catch {}
  }

  function saveLastState(){
    const data = JSON.stringify(state);
    localStorage.setItem(LS_KEYS.LAST, data);
  }

  function loadPresets(){
    try {
      const raw = localStorage.getItem(LS_KEYS.PRESETS);
      if (!raw) return {};
      return JSON.parse(raw) || {};
    } catch { return {}; }
  }

  function savePresets(presets){
    localStorage.setItem(LS_KEYS.PRESETS, JSON.stringify(presets));
  }

  function populatePresetSelect(){
    const sel = document.getElementById('presetSelect');
    const presets = loadPresets();
    // remember current selection to preserve it if still exists
    const prev = sel.value;
    sel.innerHTML = '<option value="">(none)</option>';
    Object.keys(presets).sort().forEach(name => {
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      if (name === prev) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  // ---- helpers ----
  function mm(v){ return `${v}mm`; }
  function setCSSMargins() {
    document.querySelector('.paper').style.setProperty('--margin-top-mm', mm(state.margins.top));
    document.querySelector('.paper').style.setProperty('--margin-right-mm', mm(state.margins.right));
    document.querySelector('.paper').style.setProperty('--margin-bottom-mm', mm(state.margins.bottom));
    document.querySelector('.paper').style.setProperty('--margin-left-mm', mm(state.margins.left));
  }
  function setZoom(z) {
    state.zoom = z;
    document.documentElement.style.setProperty('--paper-zoom', z);
    document.getElementById('zoomRange').value = z;
    document.getElementById('zoomVal').textContent = Math.round(z * 100) + '%';
    saveLastState();
  }

  function pageContentWidth(){ return PagePresets[state.paper].w - state.margins.left - state.margins.right; }
  function pageContentHeight(){ return PagePresets[state.paper].h - state.margins.top - state.margins.bottom; }

  function updatePageSizeCSS(){
    const styleEl = document.getElementById('pageSizeStyle');
    const cssSize = PagePresets[state.paper].css;
    styleEl.textContent = `@media print { @page { size: ${cssSize}; margin: 0; } }`;
  }

  function applyPageSize() {
    const preset = PagePresets[state.paper];
    // outer "paper" size (full sheet for a realistic preview)
    const paperDiv = document.getElementById('paper');
    paperDiv.style.width = mm(preset.w);
    paperDiv.style.height = mm(preset.h);

    // inner SVG content area (printable region inside margins)
    const svg = document.getElementById('page');
    svg.setAttribute('width', mm(pageContentWidth()));
    svg.setAttribute('height', mm(pageContentHeight()));
    svg.style.position = 'absolute';
    svg.style.left = mm(state.margins.left);
    svg.style.top = mm(state.margins.top);

    // sync original global variables expected by ic-label-creator.js
    window.globals.pageWidth = pageContentWidth();
    window.globals.pageHeight = pageContentHeight();

    updatePageSizeCSS();
  }

  function clearPage(){
    // remove all children from the SVG
    const svg = document.getElementById('page');
    while (svg.firstChild) svg.removeChild(svg.firstChild);
    // reset original globals for chip placement
    window.globals.chipPositionX = 0;
    window.globals.chipPositionY = 0;
  }

  function drawAllChips(){
    if (typeof window.drawChip !== 'function') {
      console.warn('drawChip(...) not found. Ensure ic-label-creator.js is loaded.');
      return;
    }
    // This sequence mirrors the original demo contents.
    window.drawChip('555');
    window.drawChip('555');
    window.drawChip('555');
    window.drawChip('74LS04');
    window.drawChip('74LS08');
    window.drawChip('74LS32');
    window.drawChip('74LS00');
    window.drawChip('W65C02');
    window.drawChip('W65C22');
    window.drawChip('28C256');
    window.drawChip('62256');
    window.drawChip('W65C51');
  }

  function render(){
    applyPageSize();
    setCSSMargins();
    clearPage();
    drawAllChips();
    saveLastState();
  }

  // ---- initialize default globals expected by the original code ----
  Object.assign(window.globals, {
    gimmeColor      : true,
    pageWidth       : 210 - 20, // overridden by applyPageSize()
    pageHeight      : 279.4 - 40,
    pinDistance     : 2.54,
    chipHeightBase  : 2,
    chipPositionX   : 0,
    chipPositionY   : 0,
    svgStrokeWidth  : .1,
    svgStrokeOffset : .1,
    defaultChipLogicFamily : 'LS',
    defaultChipSeries      : '74'
  });

  // ---- UI bindings ----
  const $paper = document.getElementById('paperSelect');
  const $mt = document.getElementById('marginTop');
  const $mr = document.getElementById('marginRight');
  const $mb = document.getElementById('marginBottom');
  const $ml = document.getElementById('marginLeft');
  const $zoom = document.getElementById('zoomRange');
  const $zoomIn = document.getElementById('zoomIn');
  const $zoomOut = document.getElementById('zoomOut');
  const $reset = document.getElementById('resetLayout');
  const $print = document.getElementById('printBtn');

  // Preset elements
  const $presetSelect = document.getElementById('presetSelect');
  const $applyPreset = document.getElementById('applyPreset');
  const $savePreset = document.getElementById('savePreset');
  const $deletePreset = document.getElementById('deletePreset');

  $paper.addEventListener('change', () => {
    state.paper = $paper.value;
    render();
  });
  for (const [el, key] of [[ $mt, 'top'], [$mr, 'right'], [$mb, 'bottom'], [$ml, 'left']]){
    el.addEventListener('input', () => {
      state.margins[key] = parseFloat(el.value) || 0;
      render();
    });
  }
  $zoom.addEventListener('input', () => { setZoom(parseFloat($zoom.value)); });
  $zoomIn.addEventListener('click', () => setZoom(Math.min(2, Math.round((state.zoom + 0.1)*100)/100)));
  $zoomOut.addEventListener('click', () => setZoom(Math.max(0.5, Math.round((state.zoom - 0.1)*100)/100)));

  $reset.addEventListener('click', () => {
    state.paper = 'Letter';
    state.margins = { top: 10, right: 10, bottom: 10, left: 10 };
    $paper.value = state.paper;
    $mt.value = state.margins.top; $mr.value = state.margins.right;
    $mb.value = state.margins.bottom; $ml.value = state.margins.left;
    setZoom(1);
    render();
  });

  $print.addEventListener('click', () => window.print());

  // ---- Preset logic ----
  function currentSnapshot(){
    return {
      paper: state.paper,
      margins: { ...state.margins },
      // zoom is UI-only; do not store in preset
    };
  }

  function applySnapshot(s){
    if (!s) return;
    if (s.paper) { state.paper = s.paper; $paper.value = s.paper; }
    if (s.margins) {
      state.margins = { ...s.margins };
      $mt.value = state.margins.top;
      $mr.value = state.margins.right;
      $mb.value = state.margins.bottom;
      $ml.value = state.margins.left;
    }
    render();
  }

  $applyPreset.addEventListener('click', () => {
    const name = $presetSelect.value;
    if (!name) return;
    const presets = loadPresets();
    applySnapshot(presets[name]);
  });

  $savePreset.addEventListener('click', () => {
    const name = prompt('Preset name? (e.g., "Letter tight margins", "A4 12mm")');
    if (!name) return;
    const presets = loadPresets();
    presets[name] = currentSnapshot();
    savePresets(presets);
    populatePresetSelect();
    $presetSelect.value = name;
  });

  $deletePreset.addEventListener('click', () => {
    const name = $presetSelect.value;
    if (!name) return;
    const ok = confirm(`Delete preset "${name}"?`);
    if (!ok) return;
    const presets = loadPresets();
    delete presets[name];
    savePresets(presets);
    populatePresetSelect();
  });

  // ---- First paint (respect last used state) ----
  loadLastState();
  // Sync controls with state before render
  document.getElementById('paperSelect').value = state.paper;
  $mt.value = state.margins.top; $mr.value = state.margins.right;
  $mb.value = state.margins.bottom; $ml.value = state.margins.left;
  populatePresetSelect();
  setZoom(state.zoom || 1);
  render();
})();
</script>
</body>
</html>
